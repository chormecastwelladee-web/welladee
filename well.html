<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô‡πÅ‡∏°‡πà‡∏ö‡πâ‡∏≤‡∏ô</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
body { font-family: 'Sarabun', sans-serif; }
.fade-in { animation: fadeIn 0.3s ease-in; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
#imageModal img {
    max-height: 60vh;   /* ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ */
    width: auto;
    object-fit: contain;
    transition: transform 0.3s;
    cursor: pointer;
}
#imageModal img:hover {
    transform: scale(1.05);
}
</style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">

<div class="bg-white shadow-lg border-b-4 border-blue-500">
    <div class="container mx-auto px-4 py-6">
        <h1 class="text-3xl font-bold text-gray-800 text-center">üè† ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô‡πÅ‡∏°‡πà‡∏ö‡πâ‡∏≤‡∏ô</h1>
        <div class="flex justify-center mt-4 space-x-4">
            <button onclick="showTab('tasks')" id="tasksTab" class="px-6 py-2 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600 transition-colors">
                üìã ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            </button>
            <button onclick="window.logout()">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>

            <button onclick="showTab('summary')" id="summaryTab" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-colors">
                üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô
            </button>
        </div>
    </div>
</div>

<div class="container mx-auto px-4 py-4">
    <div class="bg-white rounded-lg shadow-md p-4">
        <div class="flex justify-between items-center mb-2">
            <span class="text-sm font-medium text-gray-700">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</span>
            <span id="progressText" class="text-sm font-bold text-blue-600">0%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-3">
            <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-green-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
        </div>
    </div>
</div>

<div id="tasksContent" class="container mx-auto px-4 pb-8">
    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
        <h3 class="text-lg font-semibold mb-4 text-gray-800">üîç ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <select id="floorFilter" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô</option>
                <option value="3">‡∏ä‡∏±‡πâ‡∏ô 3</option>
                <option value="4">‡∏ä‡∏±‡πâ‡∏ô 4</option>
                <option value="5">‡∏ä‡∏±‡πâ‡∏ô 5</option>
                <option value="6">‡∏ä‡∏±‡πâ‡∏ô 6</option>
            </select>
            <select id="roomFilter" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>
            </select>
            <select id="statusFilter" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                <option value="completed">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</option>
                <option value="pending">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à</option>
            </select>
            <button onclick="resetAllTasks()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors font-medium">
                üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏∏‡∏Å‡∏á‡∏≤‡∏ô
            </button>
        </div>
    </div>

    <div id="tasksGrid" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6"></div>
</div>

<div id="summaryContent" class="container mx-auto px-4 pb-8 hidden">
    <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-2xl font-bold mb-6 text-gray-800">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
        <div id="summaryStats" class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6"></div>
        <div id="summaryTable" class="overflow-x-auto"></div>
    </div>
</div>

<div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-full max-h-full overflow-auto">
        <div class="p-4 border-b flex justify-between items-center">
            <h3 class="text-lg font-semibold">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏á‡∏≤‡∏ô</h3>
            <button onclick="closeImageModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <div id="imageModalContent" class="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        </div>
    </div>
</div>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getFirestore, collection, doc, setDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
    apiKey: "AIzaSyB0YpsZHYPOH40LFCEpgv_MrViaVkO22G8",
    authDomain: "hkkreport-8e93b.firebaseapp.com",
    projectId: "hkkreport-8e93b",
    storageBucket: "hkkreport-8e93b.firebasestorage.app",
    messagingSenderId: "50585901555",
    appId: "1:50585901555:web:6046034a7a9a3cc1921a86"
  };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const tasksCollection = collection(db, "housekeepingTasks");

const floors = {
    3: Array.from({length: 10}, (_, i) => 301 + i),
    4: Array.from({length: 10}, (_, i) => 401 + i),
    5: Array.from({length: 8}, (_, i) => 501 + i),
    6: Array.from({length: 8}, (_, i) => 601 + i)
};
const taskTypes = ['‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏á‡∏´‡πâ‡∏≠‡∏á','‡∏Å‡∏£‡∏∞‡∏à‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å','‡∏ã‡∏±‡∏Å‡∏û‡∏£‡∏°','‡∏Ç‡∏±‡∏î‡πÄ‡∏Ñ‡πâ‡∏≤‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏´‡∏¥‡∏ô‡∏≠‡πà‡∏≠‡∏ô','‡∏Ç‡∏±‡∏î‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥','‡πÉ‡∏™‡πà‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏°‡∏î','‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô corridor'];

let tasks = [];
let currentTab = 'tasks';

async function initializeTasks() {
    tasks = [];
    Object.keys(floors).forEach(floor => {
        floors[floor].forEach(room => {
            taskTypes.forEach(taskType => {
                tasks.push({
                    id: `${floor}-${room}-${taskType}`,
                    floor: floor,
                    room: room,
                    taskType: taskType,
                    status: 'pending',
                    reviewStatus: 'pending_review',
                    assignee: '',
                    reviewedBy: '',
                    images: [],
                    completedAt: null,
                    completedBy: '',
                    reviewedAt: null
                });
            });
        });
    });
    await loadTasksFromFirebase();
    renderTasks();
}

// Firebase save/load
async function saveTaskToFirebase(task){
    try {
        await setDoc(doc(db, "housekeepingTasks", task.id), task);
        console.log(`Saved task: ${task.id}`);
    } catch(err) {
        console.error("Error saving task:", err);
    }
}

async function loadTasksFromFirebase() {
    try {
        const snapshot = await getDocs(tasksCollection);
        snapshot.forEach(docSnap => {
            const savedTask = docSnap.data();
            const task = tasks.find(t => t.id === savedTask.id);
            if(task) Object.assign(task, savedTask);
        });
    } catch (err) {
        console.error("Error loading tasks:", err);
    }
}

async function saveToFirebase() {
    const batch = writeBatch(db);
    tasks.forEach(task => batch.set(doc(db, "housekeepingTasks", task.id), task));
    try { await batch.commit(); console.log("Saved all tasks"); } 
    catch(err) { console.error(err); }
}

// --- UI Functions ---
function renderTasks() {
    const grid = document.getElementById('tasksGrid');
    const floorFilter = document.getElementById('floorFilter').value;
    const roomFilter = document.getElementById('roomFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;

    let filteredTasks = tasks;
    if (floorFilter) filteredTasks = filteredTasks.filter(t => t.floor == floorFilter);
    if (roomFilter) filteredTasks = filteredTasks.filter(t => t.room == roomFilter);
    if (statusFilter) filteredTasks = filteredTasks.filter(t => t.status === statusFilter);

    const groupedTasks = {};
    filteredTasks.forEach(task => {
        const key = `${task.floor}-${task.room}`;
        if (!groupedTasks[key]) groupedTasks[key] = [];
        groupedTasks[key].push(task);
    });

    grid.innerHTML = '';
    Object.keys(groupedTasks).forEach(roomKey => {
        const [floor, room] = roomKey.split('-');
        const roomTasks = groupedTasks[roomKey];
        const completedCount = roomTasks.filter(t => t.status === 'completed').length;
        const totalCount = roomTasks.length;
        const progressPercent = totalCount ? (completedCount / totalCount) * 100 : 0;

        const roomCard = document.createElement('div');
        roomCard.className = 'bg-white rounded-lg shadow-md overflow-hidden fade-in';
        roomCard.innerHTML = `
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4">
                <h3 class="text-xl font-bold">üè† ‡∏´‡πâ‡∏≠‡∏á ${room} (‡∏ä‡∏±‡πâ‡∏ô ${floor})</h3>
                <div class="mt-2">
                    <div class="flex justify-between text-sm mb-1">
                        <span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>
                        <span>${completedCount}/${totalCount} (${Math.round(progressPercent)}%)</span>
                    </div>
                    <div class="w-full bg-blue-300 rounded-full h-2">
                        <div class="bg-white h-2 rounded-full transition-all duration-500" style="width:${progressPercent}%"></div>
                    </div>
                </div>
            </div>
            <div class="p-4">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-2">‡∏á‡∏≤‡∏ô</th>
                                <th class="text-left py-2">‡∏ú‡∏π‡πâ‡∏ó‡∏≥</th>
                                <th class="text-left py-2">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</th>
                                <th class="text-left py-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô</th>
                                <th class="text-left py-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</th>
                                <th class="text-center py-2">‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody>
                        ${roomTasks.map(task => `
                            <tr class="border-b hover:bg-gray-50 ${task.status === 'completed' ? 'bg-green-100' : ''}">
                                <td class="py-3 font-medium">${task.taskType}</td>
                                <td class="py-3">
                                    <input type="text" value="${task.assignee}" onchange="updateAssignee('${task.id}',this.value)" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô"
                                        ${task.status === 'completed' ? 'disabled' : ''} 
                                        class="w-full px-2 py-1 border rounded text-xs ${task.status === 'completed' ? 'bg-gray-100 cursor-not-allowed' : 'focus:ring-1 focus:ring-blue-500'}">
                                </td>
                                <td class="py-3">
    <div class="flex items-center space-x-2">
        <label class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 cursor-pointer">
            üì∑ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ
            <input type="file" multiple accept="image/*" class="sr-only"
            onchange="handleFileSelect('${task.id}', this.files)">
        </label>
        ${task.images.filter(img => img.uploadedUrl).length > 0 
          ? `<button onclick="viewImages('${task.id}')" class="bg-green-500 text-white px-2 py-1 rounded text-xs hover:bg-green-600">
                üëÅÔ∏è ‡∏î‡∏π‡∏£‡∏π‡∏õ (${task.images.filter(img => img.uploadedUrl).length})
            </button>` 
          : ''}
    </div>
</td>

                                <td class="py-3">
                                    <span class="px-2 py-1 rounded-full text-xs font-medium ${task.status === 'completed'?'bg-green-100 text-green-800':'bg-red-100 text-red-800'}">
                                        ${task.status === 'completed'?'‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢':'‚è≥ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à'}
                                    </span>
                                </td>
                                <td class="py-3">
                                    <span class="px-2 py-1 rounded-full text-xs font-medium ${task.reviewStatus === 'reviewed'?'bg-purple-100 text-purple-800':'bg-red-100 text-red-800'}">
                                        ${task.reviewStatus === 'reviewed'?'‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß':'‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö'}
                                    </span>
                                    <input type="text" value="${task.reviewedBy}" onchange="updateReviewer('${task.id}', this.value)" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö"
                                        ${task.reviewStatus === 'reviewed' ? 'disabled' : ''}
                                        class="w-full px-2 py-1 border rounded text-xs mt-2 ${task.reviewStatus === 'reviewed' ? 'bg-gray-100 cursor-not-allowed' : 'focus:ring-1 focus:ring-purple-500'}">
                                </td>
                                <td class="py-3 text-center">
                                    <div class="flex flex-col space-y-2">
                                        <button onclick="toggleTaskStatus('${task.id}')" class="px-3 py-1 rounded-lg text-xs font-medium transition-colors ${task.status === 'completed' ? 'bg-green-400 text-gray-700 hover:bg-gray-300' : 'bg-red-500 text-white hover:bg-green-600'}">
                                            ${task.status === 'completed'?'‚Ü©Ô∏è ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô':'‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏á‡∏≤‡∏ô'}
                                        </button>
                                        <button onclick="toggleReviewStatus('${task.id}')" class="px-3 py-1 rounded-lg text-xs font-medium transition-colors ${task.reviewStatus === 'reviewed' ? 'bg-green-500 text-white hover:bg-green-600' : 'bg-red-500 text-white hover:bg-red-600'}">
                                            ${task.reviewStatus === 'reviewed'?'‚Ü©Ô∏è ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö':'‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß'}
                                        </button>
                                    </div>
                                </td>
                            </tr>`).join('')}
                        </tbody>
                    </table>
                </div>
            </div>`;
        grid.appendChild(roomCard);
    });
    updateProgress();
}


// --- Other functions (toggleTaskStatus, updateAssignee, toggleReviewStatus, updateReviewer, resetAllTasks, uploadFile, viewImages, closeImageModal) ---
function toggleTaskStatus(taskId) {
    const task = tasks.find(t => t.id === taskId);
    if(!task) return;
    if(!task.assignee.trim()){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥‡∏Å‡πà‡∏≠‡∏ô'); return; }
    if(task.status==='pending'){ task.status='completed'; task.completedAt=new Date().toISOString(); task.completedBy=task.assignee; }
    else{ task.status='pending'; task.completedAt=null; task.completedBy=''; task.reviewStatus='pending_review'; task.reviewedBy=''; task.reviewedAt=null; }
    saveTaskToFirebase(task); renderTasks(); if(currentTab==='summary') renderSummary();
}

// ‡∏ó‡∏≥‡πÉ‡∏´‡πâ uploadFile ‡πÄ‡∏õ‡πá‡∏ô global


// ‡∏Å‡∏≥‡∏´‡∏ô‡∏î event listener ‡πÉ‡∏´‡πâ input
document.addEventListener('change', function(e){
    if(e.target.matches('.file-input')){
        const taskId = e.target.dataset.taskid;
        const task = tasks.find(t => t.id === taskId);
        if(task){
            Array.from(e.target.files).forEach(file => uploadFile(file, task));
        }
    }
});



function updateAssignee(id,value){ const t=tasks.find(x=>x.id===id); if(!t) return; if(t.status==='completed'){ alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ'); renderTasks(); return; } t.assignee=value; saveTaskToFirebase(t); renderTasks(); }
function toggleReviewStatus(taskId){ const t=tasks.find(x=>x.id===taskId); if(!t) return; if(t.status!=='completed'){ alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÑ‡∏î‡πâ'); return; } if(!t.reviewedBy.trim()){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô'); return; } t.reviewStatus = t.reviewStatus==='pending_review'?'reviewed':'pending_review'; t.reviewedAt = t.reviewStatus==='reviewed'?new Date().toISOString():null; saveTaskToFirebase(t); renderTasks(); if(currentTab==='summary') renderSummary(); }
function updateReviewer(id,value){ const t=tasks.find(x=>x.id===id); if(!t) return; if(t.reviewStatus==='reviewed'){ alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ'); renderTasks(); return; } t.reviewedBy=value; saveTaskToFirebase(t); renderTasks(); }
async function resetAllTasks(){ if(!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return; tasks.forEach(t=>{ t.status='pending'; t.completedAt=null; t.completedBy=''; t.assignee=''; t.images=[]; t.reviewStatus='pending_review'; t.reviewedBy=''; t.reviewedAt=null; }); await saveToFirebase(); renderTasks(); }


function handleFileSelect(taskId, files) {
    const task = tasks.find(t => t.id === taskId);
    if (!task) return;
    if (!task.images) task.images = [];

    Array.from(files).forEach(file => {
        // ‡πÄ‡∏Å‡πá‡∏ö file ‡πÑ‡∏ß‡πâ upload
        task.images.push({ uploadedUrl: null, file });
        uploadFile(file, task); // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    });
}
window.handleFileSelect = handleFileSelect;


async function uploadFile(file, task) {
    if (!file || !task) return;

    const cloudName = "duqvqdrwd"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const uploadPreset = "unsigned_preset"; // ‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏ô Cloudinary ‡πÅ‡∏ö‡∏ö Unsigned
    const url = `https://api.cloudinary.com/v1_1/${cloudName}/image/upload`;

    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", uploadPreset);

    try {
        const response = await fetch(url, { method: "POST", body: formData });
        const data = await response.json();

        if (data.secure_url) {
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô task: ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà object ‡πÄ‡∏î‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ uploadedUrl
            task.images = task.images.map(img =>
                img.file === file ? { uploadedUrl: data.secure_url } : img
            );

            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firebase
            await setDoc(doc(db, "housekeepingTasks", task.id), task);

            renderTasks();
        } else {
            console.error("Upload error:", data);
            alert("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (data.error?.message || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"));
        }
    } catch (err) {
        console.error("Fetch error:", err);
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î");
    }
}
window.uploadFile = uploadFile;




function viewImages(taskId) {
    const task = tasks.find(x => x.id === taskId);
    if (!task || !task.images.length) return;

    const container = document.getElementById('imageModalContent');
    container.innerHTML = task.images
        .filter(img => img.uploadedUrl)
        .map(img => `<img src="${img.uploadedUrl}" class="w-full max-h-64 object-contain mb-2 image-preview rounded shadow cursor-pointer" 
                     onclick="window.open('${img.uploadedUrl}', '_blank')">`).join('');

    document.getElementById('imageModal').classList.remove('hidden');
}





function closeImageModal(){ document.getElementById('imageModal').classList.add('hidden'); }
function updateProgress(){ const total=tasks.length; const done=tasks.filter(t=>t.status==='completed').length; const percent = total? Math.round((done/total)*100):0; document.getElementById('progressBar').style.width=`${percent}%`; document.getElementById('progressText').textContent=`${percent}%`; }
function showTab(tab){ currentTab=tab; document.getElementById('tasksContent').classList.toggle('hidden',tab!=='tasks'); document.getElementById('summaryContent').classList.toggle('hidden',tab!=='summary'); document.getElementById('tasksTab').classList.toggle('bg-blue-500',tab==='tasks'); document.getElementById('tasksTab').classList.toggle('bg-gray-200',tab!=='tasks'); document.getElementById('summaryTab').classList.toggle('bg-blue-500',tab==='summary'); document.getElementById('summaryTab').classList.toggle('bg-gray-200',tab!=='summary'); if(tab==='summary') renderSummary(); }
function renderSummary(){ const statsDiv=document.getElementById('summaryStats'); const tableDiv=document.getElementById('summaryTable'); statsDiv.innerHTML=''; tableDiv.innerHTML=''; const floorGroups={}; tasks.forEach(t=>{ if(!floorGroups[t.floor]) floorGroups[t.floor]=[]; floorGroups[t.floor].push(t); }); Object.keys(floorGroups).forEach(f=>{ const fl=floorGroups[f]; const total=fl.length; const done=fl.filter(x=>x.status==='completed').length; const reviewed=fl.filter(x=>x.reviewStatus==='reviewed').length; const card=document.createElement('div'); card.className='bg-blue-100 rounded p-4 text-center'; card.innerHTML=`<div class="font-bold text-lg">${f} ‡∏ä‡∏±‡πâ‡∏ô</div><div>‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${total}</div><div>‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß: ${done}</div><div>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß: ${reviewed}</div>`; statsDiv.appendChild(card); }); const rows=tasks.map(t=>`<tr class="border-b"><td class="px-2 py-1">${t.floor}-${t.room}</td><td class="px-2 py-1">${t.taskType}</td><td class="px-2 py-1">${t.assignee}</td><td class="px-2 py-1">${t.status}</td><td class="px-2 py-1">${t.reviewStatus}</td></tr>`).join(''); tableDiv.innerHTML=`<table class="w-full text-sm"><thead><tr class="border-b bg-gray-100"><th>‡∏´‡πâ‡∏≠‡∏á</th><th>‡∏á‡∏≤‡∏ô</th><th>‡∏ú‡∏π‡πâ‡∏ó‡∏≥</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</th></tr></thead><tbody>${rows}</tbody></table>`; }


function logout() {
    localStorage.removeItem("loggedInUser");
    window.location.href = "login.html";
}


document.addEventListener('DOMContentLoaded',()=>{
   const user = localStorage.getItem("loggedInUser");
    if (!user) {
        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ login ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ login
        window.location.href = "login.html";
        return;
    }
    initializeTasks();

    window.toggleTaskStatus = toggleTaskStatus;
    window.updateAssignee = updateAssignee;
    window.toggleReviewStatus = toggleReviewStatus;
    window.updateReviewer = updateReviewer;
    window.resetAllTasks = resetAllTasks;
    window.uploadFile = uploadFile;
    window.viewImages = viewImages;
    window.closeImageModal = closeImageModal;
    window.showTab = showTab;
    window.logout = logout;



    Object.keys(floors).forEach(f=>{
        const sel=document.getElementById('floorFilter');
        sel.addEventListener('change',()=>{
            const val=sel.value;
            const roomSel=document.getElementById('roomFilter');
            roomSel.innerHTML='<option value="">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>';
            if(val&&floors[val]) floors[val].forEach(r=>{
                roomSel.innerHTML+=`<option value="${r}">${r}</option>`
            });
            renderTasks();
        });
    });

    document.getElementById('roomFilter').addEventListener('change',renderTasks);
    document.getElementById('statusFilter').addEventListener('change',renderTasks);
});


</script>

</body>
</html>
